<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>会議室予約</title>
  <link href="http://osc2012do-ajax-hands-on.herokuapp.com/css/style.css" rel="stylesheet" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" ></script>
</head>
<body>
  <header>
    <h1>会議室予約状況</h1>
  </header>
  <div id="statuses">
    <div id="date-field">
      <div class="button date_shift left" >&lt;&lt;</div>
      <div class="button date_shift right" >&gt;&gt;</div>
      <h2 class="date">yyyy-MM-dd</h2>
    </div>
    
    <table class="reservations">
      <tr>
        <th>部屋</th>
        <th class="capacity">定員</th>
        <th class="morning">午前</th>
        <th class="daytime">午後</th>
        <th class="night">夜間</th>
      </tr>
      <tr id="seminar-room-a">
        <td>セミナールームA</td>
        <td class="capacity">150人</td>
        <td data-division="morning">
          <span class="status">不明</span>
          <span class="reserve button">予約</span>
        </td>
        <td data-division="daytime">
          <span class="status">不明</span>
          <span class="reserve button">予約</span>
        </td>
        <td data-division="night">
          <span class="status">不明</span>
          <span class="reserve button">予約</span>
        </td>
      </tr>
      <tr id="seminar-room-b">
        <td>セミナールームB</td>
        <td class="capacity">40人</td>
        <td data-division="morning">
          <span class="status">不明</span>
          <span class="reserve button">予約</span>
        </td>
        <td data-division="daytime">
          <span class="status">不明</span>
          <span class="reserve button">予約</span>
        </td>
        <td data-division="night">
          <span class="status">不明</span>
          <span class="reserve button">予約</span>
        </td>
      </tr>
      <tr id="seminar-room-c">
        <td>セミナールームC</td>
        <td class="capacity">30人</td>
        <td data-division="morning">
          <span class="status">不明</span>
          <span class="reserve button">予約</span>
        </td>
        <td data-division="daytime">
          <span class="status">不明</span>
          <span class="reserve button">予約</span>
        </td>
        <td data-division="night">
          <span class="status">不明</span>
          <span class="reserve button">予約</span>
        </td>
      </tr>
      <tr id="practical-room">
        <td>実習室</td>
        <td class="capacity">-</td>
        <td data-division="morning">
          <span class="status">不明</span>
          <span class="reserve button">予約</span>
        </td>
        <td data-division="daytime">
          <span class="status">不明</span>
          <span class="reserve button">予約</span>
        </td>
        <td data-division="night">
          <span class="status">不明</span>
          <span class="reserve button">予約</span>
        </td>
      </tr>
      <tr id="conference-room">
        <td>会議室</td>
        <td class="capacity">14人</td>
        <td data-division="morning">
          <span class="status">不明</span>
          <span class="reserve button">予約</span>
        </td>
        <td data-division="daytime">
          <span class="status">不明</span>
          <span class="reserve button">予約</span>
        </td>
        <td data-division="night">
          <span class="status">不明</span>
          <span class="reserve button">予約</span>
        </td>
      </tr>
    </table>
    
    <div class="button reload">更新</div>
  </div>
</body>
</html>
<script>
// 通常は js は別ファイルに記載するが、今回は見やすさを考慮して HTML ファイル中に記載している。

// 演習1. 今日の日付を表示する
// $() に登録した関数は DOM の操作が可能になった時点で実行される
$(function() {
    // 現在の日付を表す文字列を生成
    var currentDate = new Date();
    var dateString = formatDate(currentDate);
    // date クラスを持つ element のテキストを現在の日付に書き換え
    $(".date").text(dateString);
});

// 演習2. 会議室の利用状況を取得し、テーブルに反映する
RESERVATION_URL = "http://osc2012do-ajax-hands-on.herokuapp.com/reservations";
$(function() {
    // リクエスト時に付加するデータ
    data = {
        date: formatDate(new Date())
    };
    // API にリクエスト送ってJSON 形式でデータを取得する
    $.getJSON(RESERVATION_URL, data, function(reservations) {
        // レスポンス時にコールバックとして実行される関数
        // reservations は次のような形式の配列で返ってくる
        // [
        //   { date:"2012-6-16", roomId:"seminar-room-a", division:"morning", reserver:"権兵衛" },
        //   { date:"2012-6-16", roomId:"seminar-room-a", division:"night", reserver:"権兵衛" },
        //   ・・・
        // ]
        
        // 予約がない場合は reservations にデータが入っていないため、事前に全ての予約状況を"空き"に変更する
        $(".status").text("空き");
        // reservations の情報を使用して予約状況テーブルを更新する
        $.each(reservations, function(i, reservation) {
            $("#" + reservation.roomId + " [data-division=" + reservation.division + "] .status").text(reservation.reserver);
        });
    });
});

function formatDate(date) {
    return date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate();
}
</script>
